<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gas Bidding – Cheapest Combo (Price per MMSCF)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;       /* slate-900 */
      --card: #111827;     /* gray-900 */
      --muted: #1f2937;    /* gray-800 */
      --text: #e5e7eb;     /* gray-200 */
      --sub: #9ca3af;      /* gray-400 */
      --accent: #22c55e;   /* green-500 */
      --accent-2: #3b82f6; /* blue-500 */
      --danger: #ef4444;   /* red-500 */
      --warning: #f59e0b;  /* amber-500 */
      --border: #374151;   /* gray-700 */
      --focus: #93c5fd;    /* blue-300 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1220, var(--bg));
      color: var(--text);
    }
    .container {
      max-width: 1100px; margin: 32px auto; padding: 0 16px;
    }
    .card {
      background: rgba(17, 24, 39, 0.85);
      border: 1px solid var(--border);
      border-radius: 16px; padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }
    h1 { font-size: 1.6rem; margin: 0 0 10px; }
    .sub { color: var(--sub); font-size: 0.95rem; margin-bottom: 16px; }
    .grid {
      display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    label { font-size: 0.9rem; color: var(--sub); }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--border); background: var(--muted); color: var(--text);
      outline: none;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(59,130,246,0.25); }
    .btn {
      border: 1px solid var(--border); background: #0b1324; color: var(--text);
      padding: 10px 14px; border-radius: 10px; cursor: pointer;
    }
    .btn:hover { border-color: var(--accent-2); }
    .btn.primary { background: var(--accent-2); border-color: var(--accent-2); color: white; }
    .btn.success { background: var(--accent); border-color: var(--accent); color: #08140a; }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
    .btn.warning { background: var(--warning); border-color: var(--warning); color: #1a1203; }
    .btn.ghost { background: transparent; }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      text-align: left; padding: 10px 8px; border-bottom: 1px dashed var(--border);
      vertical-align: middle;
    }
    th { color: var(--sub); font-weight: 600; font-size: 0.9rem; }
    tr:last-child td { border-bottom: none; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--sub); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0b1324; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); color: var(--focus); }
    .right { text-align: right; }
    .center { text-align: center; }
    .mt-8 { margin-top: 16px; }
    .mt-16 { margin-top: 24px; }
    .small { font-size: 0.85rem; color: var(--sub); }
    .note { border-left: 3px solid var(--accent-2); padding: 10px 12px; background: #0b1324; border-radius: 8px; }
    .wrap { overflow-x: auto; }
    .badge-warn { color: #fde68a; }
    .footer { color: var(--sub); font-size: 0.8rem; text-align: center; margin-top: 18px; }
    .link { color: #93c5fd; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .hidden { display:none; }
    .num { text-align: right; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Gas Bidding – Cheapest Combo</h1>
      <div class="sub">Enter bids priced <b>per MMSCF</b>, set a target volume, then compute the least-cost selection.</div>

      <div class="grid">
        <div class="col" style="grid-column: span 3;">
          <label>Currency label</label>
          <input id="currency" type="text" value="USD" aria-label="Currency label (e.g., USD, RM)" />
        </div>
        <div class="col" style="grid-column: span 3;">
          <label>Target volume (MMSCF)</label>
          <input id="target" type="number" min="0" step="0.0001" value="100" aria-label="Target volume in MMSCF" />
        </div>
        <div class="col" style="grid-column: span 3;">
          <label>Round decimals</label>
          <input id="decimals" type="number" min="0" max="6" step="1" value="3" aria-label="Number of decimals" />
        </div>
        <div class="col" style="grid-column: span 3; display:flex; align-items:flex-end; gap:8px;">
          <button class="btn primary" id="btn-compute" title="Find cheapest combination">Find Cheapest Combo</button>
          <button class="btn ghost" id="btn-clear" title="Clear all rows">Clear Rows</button>
        </div>
      </div>

      <div class="mt-16 row">
        <button class="btn" id="btn-add">Add Row</button>
        <label class="small">Tip: paste on any cell to auto-fill columns from a comma-separated line (Supplier, PricePerMMSCF, VolumeMMSCF).</label>
      </div>

      <div class="mt-8 wrap">
        <table id="bids-table" aria-label="Bids table">
          <thead>
            <tr>
              <th>#</th>
              <th>Supplier</th>
              <th class="right">Price / MMSCF</th>
              <th class="right">Max Volume (MMSCF)</th>
              <th class="center">Keep?</th>
              <th class="center">Remove</th>
            </tr>
          </thead>
          <tbody id="bids-body">
            <!-- Rows inserted here -->
          </tbody>
        </table>
      </div>

      <div class="mt-8 row">
        <input type="file" id="csv-input" accept=".csv,text/csv" class="hidden" />
        <button class="btn" id="btn-import">Import CSV</button>
        <button class="btn" id="btn-export">Export Bids CSV</button>
      </div>

      <div class="mt-16">
        <div class="row">
          <button class="btn success" id="btn-export-solution" disabled>Export Solution CSV</button>
          <span class="small">Columns: Supplier, TakenVolume(MMSCF), UnitPrice(/MMSCF), Cost</span>
        </div>

        <div id="results" class="mt-8 hidden">
          <div class="note">
            <div id="status-line"></div>
            <div id="totals-line" class="small"></div>
          </div>

          <div class="mt-8 wrap">
            <table id="solution-table" aria-label="Solution table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Supplier</th>
                  <th class="right">Taken (MMSCF)</th>
                  <th class="right">Unit Price (/MMSCF)</th>
                  <th class="right">Cost</th>
                </tr>
              </thead>
              <tbody id="solution-body"></tbody>
              <tfoot>
                <tr>
                  <th colspan="2" class="right">Totals</th>
                  <th class="right" id="sol-total-vol">0</th>
                  <th></th>
                  <th class="right" id="sol-total-cost">0</th>
                </tr>
                <tr>
                  <th colspan="2" class="right">Weighted Avg Price (/MMSCF)</th>
                  <th class="right" id="sol-wap" colspan="3">0</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="mt-16">
        <details>
          <summary><span class="pill">CSV format help</span></summary>
          <div class="small" style="margin-top:10px;">
            <p>CSV columns (no header needed): <code>Supplier, PricePerMMSCF, MaxVolumeMMSCF</code></p>
            <p>Example:</p>
            <pre class="kbd">Alpha Gas, 10.75, 80
Beta LNG,  11.20, 50
Vittol,    10.50, 40
Shell,     11.00, 100</pre>
          </div>
        </details>
      </div>

      <div class="footer">Made for quick gas bid screening (price per MMSCF). No data leaves your browser.</div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const fmt = (n, d=3) => {
      if (!isFinite(n)) return "—";
      const v = Number(n);
      return v.toLocaleString(undefined, { maximumFractionDigits: d, minimumFractionDigits: Math.min(d, 3) });
    };
    const parseNum = (v) => {
      if (typeof v === "number") return v;
      if (!v) return NaN;
      return Number(String(v).replace(/,/g, "").trim());
    };

    // ---------- State ----------
    let lastSolution = null;

    // ---------- Row management ----------
    function addRow(data = {}) {
      const tbody = $("#bids-body");
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td class="center idx"></td>
        <td><input type="text" placeholder="Supplier" value="${(data.supplier ?? "").toString().replace(/"/g, '&quot;')}" /></td>
        <td class="num"><input type="number" step="0.0001" min="0" placeholder="Price per MMSCF" value="${data.price ?? ""}" /></td>
        <td class="num"><input type="number" step="0.0001" min="0" placeholder="Max Volume (MMSCF)" value="${data.volume ?? ""}" /></td>
        <td class="center"><input type="checkbox" class="keep" ${data.keep === false ? "" : "checked"} title="Uncheck to exclude a row without deleting it" /></td>
        <td class="center"><button class="btn danger btn-del" title="Remove this row">Remove</button></td>
      `;

      // Paste helper: allow pasting "Supplier, price, volume" into any cell
      tr.querySelectorAll("input").forEach(inp => {
        inp.addEventListener("paste", (e) => {
          const text = (e.clipboardData || window.clipboardData).getData("text");
          if (text && text.split(",").length >= 2) {
            e.preventDefault();
            const parts = text.split(",").map(s => s.trim());
            const [supplier, price, volume] = parts;
            tr.querySelectorAll("input")[0].value = supplier ?? "";
            tr.querySelectorAll("input")[1].value = price ?? "";
            tr.querySelectorAll("input")[2].value = volume ?? "";
          }
        });
      });

      tr.querySelector(".btn-del").addEventListener("click", () => {
        tr.remove();
        reindex();
      });

      tbody.appendChild(tr);
      reindex();
    }

    function reindex() {
      $$("#bids-body tr").forEach((tr, i) => {
        const idx = tr.querySelector(".idx");
        idx.textContent = String(i + 1);
      });
    }

    function readRows() {
      const rows = [];
      $$("#bids-body tr").forEach(tr => {
        const [supplierEl, priceEl, volEl] = tr.querySelectorAll("input");
        const keepEl = tr.querySelector(".keep");
        const supplier = supplierEl.value.trim();
        const price = parseNum(priceEl.value);
        const volume = parseNum(volEl.value);
        const keep = keepEl.checked;

        // Allow blank rows to be ignored
        if (!supplier && !isFinite(price) && !isFinite(volume)) return;

        rows.push({ supplier, price, volume, keep });
      });
      return rows;
    }

    function clearRows() {
      $("#bids-body").innerHTML = "";
      reindex();
      resetResults();
    }

    // ---------- CSV I/O ----------
    function toCSV(rows) {
      const esc = (s) => {
        const v = String(s ?? "");
        if (v.includes(",") || v.includes('"') || v.includes("\n")) {
          return `"${v.replace(/"/g, '""')}"`;
        }
        return v;
      };
      const lines = rows.map(r => [r.supplier, r.price, r.volume].map(esc).join(","));
      return lines.join("\n");
    }

    function fromCSV(text) {
      // Simple CSV parser for 3 columns per line
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const parsed = [];
      for (const line of lines) {
        // Split by commas not inside quotes
        const parts = [];
        let cur = "";
        let inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQ && line[i+1] === '"') { cur += '"'; i++; }
            else inQ = !inQ;
          } else if (ch === ',' && !inQ) {
            parts.push(cur); cur = "";
          } else {
            cur += ch;
          }
        }
        parts.push(cur);
        const [supplier="", price="", volume=""] = parts.map(s => s.trim());
        parsed.push({
          supplier,
          price: parseNum(price),
          volume: parseNum(volume),
        });
      }
      return parsed;
    }

    function download(filename, text) {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([text], { type: "text/plain" }));
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // ---------- Compute cheapest combo ----------
    function compute() {
      resetResults();

      const currency = $("#currency").value.trim() || "USD";
      const decimals = Math.max(0, Math.min(6, parseInt($("#decimals").value || "3", 10)));
      const target = parseNum($("#target").value);

      const rows = readRows().filter(r => r.keep);
      const errors = [];

      if (!isFinite(target) || target <= 0) errors.push("Target volume must be a positive number.");
      rows.forEach((r, i) => {
        if (!r.supplier) errors.push(`Row ${i+1}: Supplier is empty.`);
        if (!isFinite(r.price) || r.price < 0) errors.push(`Row ${i+1}: Invalid price.`);
        if (!isFinite(r.volume) || r.volume < 0) errors.push(`Row ${i+1}: Invalid volume.`);
      });

      if (rows.length === 0) errors.push("No valid rows to evaluate.");

      if (errors.length) {
        showStatus(errors.join(" "), "error");
        return;
      }

      // Sort by ascending unit price
      const sorted = rows.slice().sort((a, b) => a.price - b.price);

      let remaining = target;
      const take = [];
      for (const r of sorted) {
        if (remaining <= 0) break;
        const qty = Math.min(remaining, r.volume);
        if (qty > 0) {
          take.push({
            supplier: r.supplier,
            unit: r.price,
            qty,
            cost: qty * r.price
          });
          remaining -= qty;
        }
      }

      const totalVol = take.reduce((s, x) => s + x.qty, 0);
      const totalCost = take.reduce((s, x) => s + x.cost, 0);
      const wap = totalVol > 0 ? totalCost / totalVol : NaN;

      // Render solution
      const tbody = $("#solution-body");
      tbody.innerHTML = "";
      take.forEach((x, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="center">${i+1}</td>
          <td>${x.supplier}</td>
          <td class="right">${fmt(x.qty, decimals)}</td>
          <td class="right">${fmt(x.unit, decimals)}</td>
          <td class="right">${currency} ${fmt(x.cost, decimals)}</td>
        `;
        tbody.appendChild(tr);
      });

      $("#sol-total-vol").textContent = fmt(totalVol, decimals);
      $("#sol-total-cost").textContent = currency + " " + fmt(totalCost, decimals);
      $("#sol-wap").textContent = fmt(wap, decimals);

      const results = $("#results");
      results.classList.remove("hidden");

      const shortage = Math.max(0, target - totalVol);
      if (shortage > 0) {
        showStatus(
          `Target: <b>${fmt(target, decimals)} MMSCF</b>. Supply short by <span class="badge-warn"><b>${fmt(shortage, decimals)} MMSCF</b></span>.`,
          "warn"
        );
      } else {
        showStatus(
          `Target: <b>${fmt(target, decimals)} MMSCF</b>. Fully covered by the cheapest combination.`,
          "ok"
        );
      }
      $("#totals-line").innerHTML = `Total Cost: <b>${currency} ${fmt(totalCost, decimals)}</b> &nbsp;•&nbsp; Weighted Avg Price: <b>${fmt(wap, decimals)} / MMSCF</b>`;

      lastSolution = { currency, decimals, target, take, totalVol, totalCost, wap };
      $("#btn-export-solution").disabled = take.length === 0;
    }

    function resetResults() {
      $("#results").classList.add("hidden");
      $("#status-line").innerHTML = "";
      $("#totals-line").innerHTML = "";
      lastSolution = null;
      $("#btn-export-solution").disabled = true;
    }

    function showStatus(msg, kind="ok") {
      const el = $("#status-line");
      const icon = kind === "ok" ? "✅" : kind === "warn" ? "⚠️" : "❌";
      const color = kind === "ok" ? "var(--accent)" :
                    kind === "warn" ? "var(--warning)" : "var(--danger)";
      el.innerHTML = `${icon} <span style="color:${color}">${msg}</span>`;
    }

    // ---------- Export solution ----------
    function exportSolutionCSV() {
      if (!lastSolution) return;
      const d = lastSolution.decimals ?? 3;
      const rows = lastSolution.take.map(x => ({
        Supplier: x.supplier,
        TakenVolume_MMSCF: Number(x.qty.toFixed(d)),
        UnitPrice_per_MMSCF: Number(x.unit.toFixed(d)),
        Cost: Number(x.cost.toFixed(d))
      }));
      const header = Object.keys(rows[0] || {Supplier:"",TakenVolume_MMSCF:"",UnitPrice_per_MMSCF:"",Cost:""}).join(",");
      const lines = rows.map(r => Object.values(r).join(","));
      const csv = [header, ...lines].join("\n");
      download("gas-bidding-solution.csv", csv);
    }

    // ---------- Events ----------
    $("#btn-add").addEventListener("click", () => addRow());
    $("#btn-clear").addEventListener("click", clearRows);
    $("#btn-compute").addEventListener("click", compute);

    $("#btn-export").addEventListener("click", () => {
      const rows = readRows();
      if (rows.length === 0) return download("bids.csv", "");
      download("bids.csv", toCSV(rows));
    });

    $("#btn-import").addEventListener("click", () => $("#csv-input").click());
    $("#csv-input").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      const parsed = fromCSV(text);
      if (parsed.length === 0) return;
      clearRows();
      parsed.forEach(r => addRow(r));
    });

    $("#btn-export-solution").addEventListener("click", exportSolutionCSV);

    // Seed with sample rows
    [
      { supplier: "Alpha Gas", price: 10.75, volume: 80 },
      { supplier: "Vittol",    price: 10.50, volume: 40 },
      { supplier: "Shell",     price: 11.00, volume: 100 },
      { supplier: "Beta LNG",  price: 11.20, volume: 50 }
    ].forEach(addRow);
  </script>
</body>
</html>
